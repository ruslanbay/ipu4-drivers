From d47c5cd1d83f8d7a526c37cd1ce9a9987a2a6965 Mon Sep 17 00:00:00 2001
From: Ruslan Bay <67730802+ruslanbay@users.noreply.github.com>
Date: Tue, 17 Feb 2026 06:23:27 +0000
Subject: [PATCH 49/56] Prevent NULL dereference on stream-aware subdevs
 without routing

---
 drivers/media/pci/intel/ipu-isys-subdev.c | 19 +++++++++++++------
 1 file changed, 13 insertions(+), 6 deletions(-)

diff --git a/drivers/media/pci/intel/ipu-isys-subdev.c b/drivers/media/pci/intel/ipu-isys-subdev.c
index 4f86cb01a5fe..64562a479dc6 100644
--- a/drivers/media/pci/intel/ipu-isys-subdev.c
+++ b/drivers/media/pci/intel/ipu-isys-subdev.c
@@ -157,8 +157,11 @@ struct v4l2_mbus_framefmt *__ipu_isys_get_ffmt(struct v4l2_subdev *sd,
 
 	if (which == V4L2_SUBDEV_FORMAT_ACTIVE)
 		return &asd->ffmt[pad][stream];
-	else
-		return v4l2_subdev_state_get_format(cfg, pad);
+
+	struct v4l2_mbus_framefmt *ffmt = v4l2_subdev_state_get_format(cfg, pad);
+	if (!ffmt)
+	    ffmt = &asd->ffmt[pad][stream];
+	return ffmt;
 }
 
 struct v4l2_rect *__ipu_isys_get_selection(struct v4l2_subdev *sd,
@@ -176,11 +179,15 @@ struct v4l2_rect *__ipu_isys_get_selection(struct v4l2_subdev *sd,
 			return &asd->compose[pad];
 		}
 	} else {
+		struct v4l2_rect *rect;
+
 		switch (target) {
-		case V4L2_SEL_TGT_CROP:
-			return v4l2_subdev_state_get_crop(cfg, pad);
-		case V4L2_SEL_TGT_COMPOSE:
-			return v4l2_subdev_state_get_compose(cfg, pad);
+			case V4L2_SEL_TGT_CROP:
+			    rect = v4l2_subdev_state_get_crop(cfg, pad);
+			    return rect ? rect : &asd->crop[pad];
+			case V4L2_SEL_TGT_COMPOSE:
+			    rect = v4l2_subdev_state_get_compose(cfg, pad);
+			    return rect ? rect : &asd->compose[pad];
 		}
 	}
 	WARN_ON(1);
-- 
2.51.0

