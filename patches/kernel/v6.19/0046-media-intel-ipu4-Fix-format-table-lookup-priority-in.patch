From b97f52153f5bbc176c5ac1d9cfcbc5a87ef2d2c2 Mon Sep 17 00:00:00 2001
From: Ruslan Bay <67730802+ruslanbay@users.noreply.github.com>
Date: Tue, 17 Feb 2026 12:46:48 +0000
Subject: [PATCH 46/54] media: intel/ipu4: Fix format table lookup priority in
 link_validate()

Search per-device av->pfmts (packed formats) first for matching pixelformat
before falling back to global ipu_isys_get_isys_format(). For CSI-2 capture
with formats like SBGGR10P, the packed fourcc was not found in the global table,
causing incorrect mbus code resolution and permanent format mismatch.
---
 drivers/media/pci/intel/ipu-isys-video.c | 15 ++++++++++++++-
 1 file changed, 14 insertions(+), 1 deletion(-)

diff --git a/drivers/media/pci/intel/ipu-isys-video.c b/drivers/media/pci/intel/ipu-isys-video.c
index d0a0ff2749fa..1a6aeef7506a 100644
--- a/drivers/media/pci/intel/ipu-isys-video.c
+++ b/drivers/media/pci/intel/ipu-isys-video.c
@@ -793,7 +793,20 @@ static int link_validate(struct media_link *link)
 		s_fmt = &asd->ffmt[s_pad->index][s_stream];
 	}
 
-	code = ipu_isys_get_isys_format(ipu_isys_get_format(av), 0)->code;
+	{
+		const struct ipu_isys_pixelformat *pfmt;
+		u32 pixfmt = ipu_isys_get_format(av);
+
+		code = 0;
+		for (pfmt = av->pfmts; pfmt->bpp; pfmt++) {
+			if (pfmt->pixelformat == pixfmt) {
+				code = pfmt->code;
+				break;
+			}
+		}
+		if (!code)
+			code = ipu_isys_get_isys_format(pixfmt, 0)->code;
+	}
 
 	if (s_fmt->width != ipu_isys_get_frame_width(av) ||
 	    s_fmt->height != ipu_isys_get_frame_height(av) ||
-- 
2.51.0

