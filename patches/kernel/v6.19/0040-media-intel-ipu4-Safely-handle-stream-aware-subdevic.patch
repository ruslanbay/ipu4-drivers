From 913eec467f67fea8f6bf03127736cb51e3c4756c Mon Sep 17 00:00:00 2001
From: Ruslan Bay <67730802+ruslanbay@users.noreply.github.com>
Date: Tue, 17 Feb 2026 06:23:27 +0000
Subject: [PATCH 40/54] media: intel/ipu4: Safely handle stream-aware
 subdevices without routing

Add fallback logic for format state retrieval on stream-aware subdevices that
do not have explicit routing configured. Return the active format when try state
is unavailable to prevent NULL pointer dereferences.
---
 drivers/media/pci/intel/ipu-isys-subdev.c | 19 +++++++++++++------
 1 file changed, 13 insertions(+), 6 deletions(-)

diff --git a/drivers/media/pci/intel/ipu-isys-subdev.c b/drivers/media/pci/intel/ipu-isys-subdev.c
index 62efc0196442..5945c2b0febe 100644
--- a/drivers/media/pci/intel/ipu-isys-subdev.c
+++ b/drivers/media/pci/intel/ipu-isys-subdev.c
@@ -157,8 +157,11 @@ struct v4l2_mbus_framefmt *__ipu_isys_get_ffmt(struct v4l2_subdev *sd,
 
 	if (which == V4L2_SUBDEV_FORMAT_ACTIVE)
 		return &asd->ffmt[pad][stream];
-	else
-		return v4l2_subdev_state_get_format(cfg, pad);
+
+	struct v4l2_mbus_framefmt *ffmt = v4l2_subdev_state_get_format(cfg, pad);
+	if (!ffmt)
+	    ffmt = &asd->ffmt[pad][stream];
+	return ffmt;
 }
 
 struct v4l2_rect *__ipu_isys_get_selection(struct v4l2_subdev *sd,
@@ -176,11 +179,15 @@ struct v4l2_rect *__ipu_isys_get_selection(struct v4l2_subdev *sd,
 			return &asd->compose[pad];
 		}
 	} else {
+		struct v4l2_rect *rect;
+
 		switch (target) {
-		case V4L2_SEL_TGT_CROP:
-			return v4l2_subdev_state_get_crop(cfg, pad);
-		case V4L2_SEL_TGT_COMPOSE:
-			return v4l2_subdev_state_get_compose(cfg, pad);
+			case V4L2_SEL_TGT_CROP:
+			    rect = v4l2_subdev_state_get_crop(cfg, pad);
+			    return rect ? rect : &asd->crop[pad];
+			case V4L2_SEL_TGT_COMPOSE:
+			    rect = v4l2_subdev_state_get_compose(cfg, pad);
+			    return rect ? rect : &asd->compose[pad];
 		}
 	}
 	WARN_ON(1);
-- 
2.51.0

