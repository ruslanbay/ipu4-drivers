From 9bab56b99a4b7faacc140670a7803a7edde34f51 Mon Sep 17 00:00:00 2001
From: Ruslan Bay <67730802+ruslanbay@users.noreply.github.com>
Date: Tue, 17 Feb 2026 08:25:37 +0000
Subject: [PATCH 45/53] media: intel-ipu4: Add infrastructure for link
 validation

Add helper functions and data structures needed for format validation
in link_validate():

- Add ipu_isys_get_src_stream_by_src_pad() to extract source stream
  from routing information
- Add video_stream_watermark struct for tracking stream QoS parameters
- Add new fields to ipu_isys_video for format storage and stream tracking:
  pix_fmt, meta_fmt, csi2, stream, watermark, source_stream, vc, dt

These provide the foundation for proper format negotiation between
subdevices and video nodes, needed for kernel 6.18+ compatibility.
---
 drivers/media/pci/intel/ipu-isys-subdev.c | 24 +++++++++++++++++++++++
 drivers/media/pci/intel/ipu-isys-subdev.h |  1 +
 drivers/media/pci/intel/ipu-isys-video.h  | 23 ++++++++++++++++++++++
 3 files changed, 48 insertions(+)

diff --git a/drivers/media/pci/intel/ipu-isys-subdev.c b/drivers/media/pci/intel/ipu-isys-subdev.c
index 85b31027717b..7ca3c4f7f038 100644
--- a/drivers/media/pci/intel/ipu-isys-subdev.c
+++ b/drivers/media/pci/intel/ipu-isys-subdev.c
@@ -498,6 +498,30 @@ int ipu_isys_subdev_get_frame_desc(struct v4l2_subdev *sd,
 	return rval;
 }
 
+u32 ipu_isys_get_src_stream_by_src_pad(struct v4l2_subdev *sd, u32 pad)
+{
+	struct v4l2_subdev_state *state;
+	struct v4l2_subdev_route *routes;
+	unsigned int i;
+	u32 source_stream = 0;
+
+	state = v4l2_subdev_lock_and_get_active_state(sd);
+	if (!state)
+		return 0;
+
+	routes = state->routing.routes;
+	for (i = 0; i < state->routing.num_routes; i++) {
+		if (routes[i].source_pad == pad) {
+			source_stream = routes[i].source_stream;
+			break;
+		}
+	}
+
+	v4l2_subdev_unlock_state(state);
+
+	return source_stream;
+}
+
 bool ipu_isys_subdev_has_route(struct media_entity *entity,
 			       unsigned int pad0, unsigned int pad1, int *stream)
 {
diff --git a/drivers/media/pci/intel/ipu-isys-subdev.h b/drivers/media/pci/intel/ipu-isys-subdev.h
index 1cbf82858bf5..ab225db113f2 100644
--- a/drivers/media/pci/intel/ipu-isys-subdev.h
+++ b/drivers/media/pci/intel/ipu-isys-subdev.h
@@ -164,6 +164,7 @@ int ipu_isys_subdev_init(struct ipu_isys_subdev *asd,
 void ipu_isys_subdev_cleanup(struct ipu_isys_subdev *asd);
 int ipu_isys_subdev_get_frame_desc(struct v4l2_subdev *sd,
 				   struct v4l2_mbus_frame_desc *desc);
+u32 ipu_isys_get_src_stream_by_src_pad(struct v4l2_subdev *sd, u32 pad);
 int ipu_isys_subdev_set_routing(struct v4l2_subdev *sd,
 			   struct v4l2_subdev_state *state,
 			   enum v4l2_subdev_format_whence which,
diff --git a/drivers/media/pci/intel/ipu-isys-video.h b/drivers/media/pci/intel/ipu-isys-video.h
index a0612f7eb512..5ff2a992f05e 100644
--- a/drivers/media/pci/intel/ipu-isys-video.h
+++ b/drivers/media/pci/intel/ipu-isys-video.h
@@ -123,21 +123,41 @@ struct ipu_isys_pipeline {
 #define to_ipu_isys_pipeline(__pipe)				\
 	container_of((__pipe), struct ipu_isys_pipeline, pipe)
 
+struct video_stream_watermark {
+	u32 width;
+	u32 height;
+	u32 hblank;
+	u32 frame_rate;
+	u64 pixel_rate;
+	u64 stream_data_rate;
+	u16 sram_gran_shift;
+	u16 sram_gran_size;
+	struct list_head stream_node;
+};
+
 struct ipu_isys_video {
 	/* Serialise access to other fields in the struct. */
 	struct mutex mutex;
 	struct media_pad pad;
 	struct video_device vdev;
 	struct v4l2_pix_format_mplane mpix;
+	struct v4l2_pix_format pix_fmt;
+	struct v4l2_meta_format meta_fmt;
 	const struct ipu_isys_pixelformat *pfmts;
 	const struct ipu_isys_pixelformat *pfmt;
 	struct ipu_isys_queue aq;
 	struct ipu_isys *isys;
 	struct ipu_isys_pipeline ip;
+	struct ipu_isys_csi2 *csi2;
+	struct ipu_isys_stream *stream;
 	unsigned int streaming;
 	bool packed;
 	unsigned int line_header_length;	/* bits */
 	unsigned int line_footer_length;	/* bits */
+	struct video_stream_watermark watermark;
+	u32 source_stream;
+	u8 vc;
+	u8 dt;
 	const struct ipu_isys_pixelformat *(*try_fmt_vid_mplane)(
 		struct ipu_isys_video *av,
 		struct v4l2_pix_format_mplane *mpix);
@@ -152,6 +172,9 @@ extern const struct ipu_isys_pixelformat ipu_isys_pfmts[];
 extern const struct ipu_isys_pixelformat ipu_isys_pfmts_be_soc[];
 extern const struct ipu_isys_pixelformat ipu_isys_pfmts_packed[];
 
+const struct ipu_isys_pixelformat *
+ipu_isys_get_isys_format(u32 pixelformat, u32 type);
+
 const struct ipu_isys_pixelformat *
 ipu_isys_get_pixelformat(struct ipu_isys_video *av, u32 pixelformat);
 
-- 
2.51.0

