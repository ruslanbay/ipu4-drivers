From d0f27c078d560eebf22330f8e4f1d50bb852afb0 Mon Sep 17 00:00:00 2001
From: Tristan <supermepsipax@users.noreply.github.com>
Date: Sun, 8 Feb 2026 09:41:38 +0100
Subject: [PATCH 41/41] fix format table lookup and nr_queues for streaming

Three fixes that together enable frame capture:

1. link_validate() searched the global ipu_isys_pfmts (unpacked formats)
   instead of the per-device av->pfmts (packed formats). For CSI-2
   capture devices using SBGGR10P, the packed fourcc was not found,
   falling back to mbus code 0x2022 instead of correct 0x3007, causing
   a permanent format mismatch and STREAMON failure (-EPIPE).

2. nr_queues was never set for non-ISA pipelines. The streaming start
   logic waits for nr_streaming == nr_queues, but nr_queues was only
   incremented in isa_link_validate(). For direct CSI-2 capture
   pipelines, nr_queues stayed at 0 and v4l2-ctl hung forever.
   Fixed by counting video device entities during the graph walk in
   prepare_streaming().
---
 drivers/media/pci/intel/ipu-isys-video.c | 22 +++++++++++++++++++---
 1 file changed, 19 insertions(+), 3 deletions(-)

diff --git a/drivers/media/pci/intel/ipu-isys-video.c b/drivers/media/pci/intel/ipu-isys-video.c
index 0c40d50cd056..faa225c0427b 100644
--- a/drivers/media/pci/intel/ipu-isys-video.c
+++ b/drivers/media/pci/intel/ipu-isys-video.c
@@ -791,7 +791,20 @@ static int link_validate(struct media_link *link)
 		s_fmt = &asd->ffmt[s_pad->index][s_stream];
 	}
 
-	code = ipu_isys_get_isys_format(ipu_isys_get_format(av), 0)->code;
+	{
+		const struct ipu_isys_pixelformat *pfmt;
+		u32 pixfmt = ipu_isys_get_format(av);
+
+		code = 0;
+		for (pfmt = av->pfmts; pfmt->bpp; pfmt++) {
+			if (pfmt->pixelformat == pixfmt) {
+				code = pfmt->code;
+				break;
+			}
+		}
+		if (!code)
+			code = ipu_isys_get_isys_format(pixfmt, 0)->code;
+	}
 
 	if (s_fmt->width != ipu_isys_get_frame_width(av) ||
 	    s_fmt->height != ipu_isys_get_frame_height(av) ||
@@ -1891,11 +1904,14 @@ int ipu_isys_video_prepare_streaming(struct ipu_isys_video *av,
 	if (rval)
 		goto out_pipeline_stop;
 
-	/* Gather all entities in the graph. */
+	/* Gather all entities in the graph and count video queues. */
 	mutex_lock(&mdev->graph_mutex);
 	media_graph_walk_start(&graph, &av->vdev.entity);
-	while ((entity = media_graph_walk_next(&graph)))
+	while ((entity = media_graph_walk_next(&graph))) {
 		media_entity_enum_set(&ip->entity_enum, entity);
+		if (is_media_entity_v4l2_video_device(entity))
+			ip->nr_queues++;
+	}
 
 	mutex_unlock(&mdev->graph_mutex);
 
-- 
2.51.0

