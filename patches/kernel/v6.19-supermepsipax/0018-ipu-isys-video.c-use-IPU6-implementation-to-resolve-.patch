From 95466b1013501fe9ad588fa19c711076234df2f3 Mon Sep 17 00:00:00 2001
From: ruslanbay <67730802+ruslanbay@users.noreply.github.com>
Date: Tue, 16 Dec 2025 21:22:56 +0100
Subject: [PATCH 18/41] ipu-isys-video.c: use IPU6 implementation to resolve
 the `no external entity set! Driver bug?` error

---
 drivers/media/pci/intel/ipu-isys-video.c | 20 ++++++++++++++------
 1 file changed, 14 insertions(+), 6 deletions(-)

diff --git a/drivers/media/pci/intel/ipu-isys-video.c b/drivers/media/pci/intel/ipu-isys-video.c
index ede2f541cf7f..e15b07061c22 100644
--- a/drivers/media/pci/intel/ipu-isys-video.c
+++ b/drivers/media/pci/intel/ipu-isys-video.c
@@ -1813,19 +1813,26 @@ int ipu_isys_video_prepare_streaming(struct ipu_isys_video *av,
 	struct media_graph graph;
 	struct media_entity *entity;
 	struct media_device *mdev = &av->isys->media_dev;
+	struct media_pipeline *mp;
 	int rval;
 	unsigned int i;
 
-	dev_dbg(dev, "prepare stream: %d\n", state);
+	dev_dbg(dev, "prepare stream to state: %d for entity %s\n",
+		state, av->vdev.entity.name);
 
 	if (!state) {
-		ip = to_ipu_isys_pipeline(media_entity_pipeline(&av->vdev.entity));
+		mp = media_entity_pipeline(&av->vdev.entity);
+		ip = to_ipu_isys_pipeline(mp);
+		if (!ip) {
+			dev_err(dev, "%s no pipeline found for %s\n", __func__,
+				av->vdev.name);
+			return -ENODEV;
+		}
 
 		if (ip->interlaced && isys->short_packet_source ==
 		    IPU_ISYS_SHORT_PACKET_FROM_RECEIVER)
 			short_packet_queue_destroy(ip);
-		media_pipeline_stop_for_vc(av);
-		av->vdev.entity.pads[0].pipe = NULL;
+		media_pipeline_stop(av->vdev.entity.pads);
 		media_entity_enum_cleanup(&ip->entity_enum);
 		return 0;
 	}
@@ -1855,14 +1862,15 @@ int ipu_isys_video_prepare_streaming(struct ipu_isys_video *av,
 	if (rval)
 		return rval;
 
-	rval = media_pipeline_start_by_vc(av, &ip->pipe);
+	rval = media_pipeline_start(av->vdev.entity.pads, &ip->pipe);
 	if (rval < 0) {
 		dev_dbg(dev, "pipeline start failed\n");
 		goto out_enum_cleanup;
 	}
 
 	if (!ip->external) {
-		dev_err(dev, "no external entity set! Driver bug?\n");
+		dev_err(dev, "no external entity set for %s, Driver bug?\n",
+			av->vdev.name);
 		rval = -EINVAL;
 		goto out_pipeline_stop;
 	}
-- 
2.51.0

