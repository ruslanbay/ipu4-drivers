From c692c1f93e778af4cd6d5545057eee0504c217cb Mon Sep 17 00:00:00 2001
From: ruslanbay <67730802+ruslanbay@users.noreply.github.com>
Date: Sat, 27 Dec 2025 13:28:15 +0100
Subject: [PATCH 35/39] LINUX_VERSION_CODE < KERNEL_VERSION(6, 6, 0)

https://github.com/intel/ipu6-drivers/blob/9766e218112f4173be9b0f06dfae27cb40c54f40/drivers/media/pci/intel/ipu-isys.c#L864
---
 drivers/media/pci/intel/ipu-isys.c | 72 +++++++++++++-----------------
 1 file changed, 30 insertions(+), 42 deletions(-)

diff --git a/drivers/media/pci/intel/ipu-isys.c b/drivers/media/pci/intel/ipu-isys.c
index e09c0cde3..88f6f8b8d 100644
--- a/drivers/media/pci/intel/ipu-isys.c
+++ b/drivers/media/pci/intel/ipu-isys.c
@@ -441,60 +441,48 @@ static const struct v4l2_async_notifier_operations isys_async_ops = {
 };
 
 #define ISYS_MAX_PORTS 8
+
+static int isys_fwnode_parse(struct device *dev,
+			     struct v4l2_fwnode_endpoint *vep,
+			     struct v4l2_async_subdev *asd)
+{
+	struct sensor_async_subdev *s_asd =
+			container_of(asd, struct sensor_async_subdev, asd);
+
+	s_asd->csi2.port = vep->base.port;
+	s_asd->csi2.nlanes = vep->bus.mipi_csi2.num_data_lanes;
+
+	return 0;
+}
+
 static int isys_notifier_init(struct ipu_isys *isys)
 {
 	struct ipu_device *isp = isys->adev->isp;
-	struct device *dev = &isp->pdev->dev;
-	unsigned int i;
+	size_t asd_struct_size = sizeof(struct sensor_async_subdev);
 	int ret;
 
 	v4l2_async_nf_init(&isys->notifier);
-
-	for (i = 0; i < ISYS_MAX_PORTS; i++) {
-		struct v4l2_fwnode_endpoint vep = {
-			.bus_type = V4L2_MBUS_CSI2_DPHY
-		};
-		struct sensor_async_subdev *s_asd;
-		struct fwnode_handle *ep;
-
-		ep = fwnode_graph_get_endpoint_by_id(dev_fwnode(dev), i, 0,
-						FWNODE_GRAPH_ENDPOINT_NEXT);
-		if (!ep)
-			continue;
-
-		ret = v4l2_fwnode_endpoint_parse(ep, &vep);
-		if (ret) {
-			dev_err(dev, "fwnode endpoint parse failed: %d\n", ret);
-			goto err_parse;
-		}
-
-		s_asd = v4l2_async_nf_add_fwnode_remote(&isys->notifier, ep,
-							struct sensor_async_subdev);
-		if (IS_ERR(s_asd)) {
-			ret = PTR_ERR(s_asd);
-			dev_err(dev, "add remove fwnode failed: %d\n", ret);
-			goto err_parse;
-		}
-
-		s_asd->csi2.port = vep.base.port;
-		s_asd->csi2.nlanes = vep.bus.mipi_csi2.num_data_lanes;
-
-		dev_dbg(dev, "remote endpoint port %d with %d lanes added\n",
-			s_asd->csi2.port, s_asd->csi2.nlanes);
-
-		fwnode_handle_put(ep);
-
-		continue;
-
-err_parse:
-		fwnode_handle_put(ep);
+	ret = v4l2_async_nf_parse_fwnode_endpoints(&isp->pdev->dev,
+						   &isys->notifier,
+						   asd_struct_size,
+						   isys_fwnode_parse);
+	if (ret < 0) {
+		dev_err(&isys->adev->dev,
+			"v4l2 parse_fwnode_endpoints() failed: %d\n", ret);
 		return ret;
 	}
 
+	if (list_empty(&isys->notifier.asd_list)) {
+		/* isys probe could continue with async subdevs missing */
+		dev_warn(&isys->adev->dev, "no subdev found in graph\n");
+		return 0;
+	}
+
 	isys->notifier.ops = &isys_async_ops;
 	ret = v4l2_async_nf_register(&isys->v4l2_dev, &isys->notifier);
 	if (ret) {
-		dev_err(dev, "failed to register async notifier : %d\n", ret);
+		dev_err(&isys->adev->dev,
+			"failed to register async notifier : %d\n", ret);
 		v4l2_async_nf_cleanup(&isys->notifier);
 	}
 
-- 
2.48.1

