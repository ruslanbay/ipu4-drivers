From a3e3115ac31999864a10d8c9e225da0fd8cfdd64 Mon Sep 17 00:00:00 2001
From: ruslanbay <67730802+ruslanbay@users.noreply.github.com>
Date: Thu, 18 Dec 2025 12:16:03 +0100
Subject: [PATCH 2/3] libcamera: bayer_format: Add raw bayer vector formats

---
 libcamera/include/linux/videodev2.h          | 41 ++++++++++++++++++++
 libcamera/src/libcamera/bayer_format.cpp     |  2 +
 libcamera/src/libcamera/formats.cpp          |  5 ++-
 libcamera/src/libcamera/v4l2_pixelformat.cpp |  2 +
 4 files changed, 49 insertions(+), 1 deletion(-)

diff --git a/libcamera/include/linux/videodev2.h b/libcamera/include/linux/videodev2.h
index 317d063..3d1a5fc 100644
--- a/libcamera/include/linux/videodev2.h
+++ b/libcamera/include/linux/videodev2.h
@@ -707,6 +707,43 @@ struct v4l2_pix_format {
 #define V4L2_PIX_FMT_SGRBG16 v4l2_fourcc('G', 'R', '1', '6') /* 16  GRGR.. BGBG.. */
 #define V4L2_PIX_FMT_SRGGB16 v4l2_fourcc('R', 'G', '1', '6') /* 16  RGRG.. GBGB.. */
 
+/* Raw bayer vector formats. */
+#define V4L2_PIX_FMT_SBGGR8_16V32	v4l2_fourcc('b', 'V', '0', 'A')
+#define V4L2_PIX_FMT_SGBRG8_16V32	v4l2_fourcc('b', 'V', '0', 'B')
+#define V4L2_PIX_FMT_SGRBG8_16V32	v4l2_fourcc('b', 'V', '0', 'C')
+#define V4L2_PIX_FMT_SRGGB8_16V32	v4l2_fourcc('b', 'V', '0', 'D')
+#define V4L2_PIX_FMT_SBGGR10V32	v4l2_fourcc('b', 'V', '0', 'E')
+#define V4L2_PIX_FMT_SGBRG10V32	v4l2_fourcc('b', 'V', '0', 'F')
+#define V4L2_PIX_FMT_SGRBG10V32	v4l2_fourcc('b', 'V', '0', 'G')
+#define V4L2_PIX_FMT_SRGGB10V32	v4l2_fourcc('b', 'V', '0', 'H')
+#define V4L2_PIX_FMT_SBGGR12V32	v4l2_fourcc('b', 'V', '0', 'I')
+#define V4L2_PIX_FMT_SGBRG12V32	v4l2_fourcc('b', 'V', '0', 'J')
+#define V4L2_PIX_FMT_SGRBG12V32	v4l2_fourcc('b', 'V', '0', 'K')
+#define V4L2_PIX_FMT_SRGGB12V32	v4l2_fourcc('b', 'V', '0', 'L')
+
+#ifndef V4L2_PIX_FMT_SBGGR14V32
+/*
+ * Non-vectorized 14bit definitions have been upstreamed.
+ * To keep various versions of the ipu4 builds compileable use local
+ * definitions when global one's doesn't exists.
+ */
+#define V4L2_PIX_FMT_SBGGR14V32	v4l2_fourcc('b', 'V', '0', 'M')
+#define V4L2_PIX_FMT_SGBRG14V32	v4l2_fourcc('b', 'V', '0', 'N')
+#define V4L2_PIX_FMT_SGRBG14V32	v4l2_fourcc('b', 'V', '0', 'O')
+#define V4L2_PIX_FMT_SRGGB14V32	v4l2_fourcc('b', 'V', '0', 'P')
+#endif
+
+/* BEGIN remove once the user space has been updated */
+#define V4L2_PIX_FMT_SBGGR8V32 v4l2_fourcc('b', 'V', '0', 'A')
+#define V4L2_PIX_FMT_SGBRG8V32 v4l2_fourcc('b', 'V', '0', 'B')
+#define V4L2_PIX_FMT_SGRBG8V32 v4l2_fourcc('b', 'V', '0', 'C')
+#define V4L2_PIX_FMT_SRGGB8V32 v4l2_fourcc('b', 'V', '0', 'D')
+/* END remove once the user space has been updated */
+
+/* YUV vector formats. */
+#define V4L2_PIX_FMT_UYVY_V32 v4l2_fourcc('y', 'V', '3', '2')
+#define V4L2_PIX_FMT_YUYV420_V32 v4l2_fourcc('y', '0', '3', '2')
+
 /* HSV formats */
 #define V4L2_PIX_FMT_HSV24 v4l2_fourcc('H', 'S', 'V', '3')
 #define V4L2_PIX_FMT_HSV32 v4l2_fourcc('H', 'S', 'V', '4')
@@ -801,6 +838,10 @@ struct v4l2_pix_format {
 #define V4L2_PIX_FMT_PISP_COMP2_BGGR	v4l2_fourcc('P', 'C', '2', 'B') /* PiSP 8-bit mode 2 compressed BGGR bayer */
 #define V4L2_PIX_FMT_PISP_COMP2_MONO	v4l2_fourcc('P', 'C', '2', 'M') /* PiSP 8-bit mode 2 compressed monochrome */
 
+/* IPU4 */
+#define V4L2_FMT_IPU_ISA_CFG	v4l2_fourcc('i', 'p', '4', 'c')
+#define V4L2_FMT_IPU_ISYS_META	v4l2_fourcc('i', 'p', '4', 'm')
+
 /* SDR formats - used only for Software Defined Radio devices */
 #define V4L2_SDR_FMT_CU8          v4l2_fourcc('C', 'U', '0', '8') /* IQ u8 */
 #define V4L2_SDR_FMT_CU16LE       v4l2_fourcc('C', 'U', '1', '6') /* IQ u16le */
diff --git a/libcamera/src/libcamera/bayer_format.cpp b/libcamera/src/libcamera/bayer_format.cpp
index 3dab91f..51fc43d 100644
--- a/libcamera/src/libcamera/bayer_format.cpp
+++ b/libcamera/src/libcamera/bayer_format.cpp
@@ -106,6 +106,8 @@ const std::map<BayerFormat, Formats, BayerFormatComparator> bayerToFormat{
 		{ formats::SRGGB8, V4L2PixelFormat(V4L2_PIX_FMT_SRGGB8) } },
 	{ { BayerFormat::BGGR, 10, BayerFormat::Packing::None },
 		{ formats::SBGGR10, V4L2PixelFormat(V4L2_PIX_FMT_SBGGR10) } },
+	{ { BayerFormat::BGGR, 10, BayerFormat::Packing::None },
+		{ formats::SBGGR10, V4L2PixelFormat(V4L2_PIX_FMT_SBGGR10V32) } },
 	{ { BayerFormat::GBRG, 10, BayerFormat::Packing::None },
 		{ formats::SGBRG10, V4L2PixelFormat(V4L2_PIX_FMT_SGBRG10) } },
 	{ { BayerFormat::GRBG, 10, BayerFormat::Packing::None },
diff --git a/libcamera/src/libcamera/formats.cpp b/libcamera/src/libcamera/formats.cpp
index bfcdfc0..2334bae 100644
--- a/libcamera/src/libcamera/formats.cpp
+++ b/libcamera/src/libcamera/formats.cpp
@@ -611,7 +611,10 @@ const std::map<PixelFormat, PixelFormatInfo> pixelFormatInfo{
 	{ formats::SBGGR10, {
 		.name = "SBGGR10",
 		.format = formats::SBGGR10,
-		.v4l2Formats = { V4L2PixelFormat(V4L2_PIX_FMT_SBGGR10), },
+		.v4l2Formats = {
+			V4L2PixelFormat(V4L2_PIX_FMT_SBGGR10),
+			V4L2PixelFormat(V4L2_PIX_FMT_SBGGR10V32),
+		},
 		.bitsPerPixel = 10,
 		.colourEncoding = PixelFormatInfo::ColourEncodingRAW,
 		.packed = false,
diff --git a/libcamera/src/libcamera/v4l2_pixelformat.cpp b/libcamera/src/libcamera/v4l2_pixelformat.cpp
index e8b3eb9..d4dabeb 100644
--- a/libcamera/src/libcamera/v4l2_pixelformat.cpp
+++ b/libcamera/src/libcamera/v4l2_pixelformat.cpp
@@ -155,6 +155,8 @@ const std::map<V4L2PixelFormat, V4L2PixelFormat::Info> vpf2pf{
 		{ formats::SRGGB8, "8-bit Bayer RGRG/GBGB" } },
 	{ V4L2PixelFormat(V4L2_PIX_FMT_SBGGR10),
 		{ formats::SBGGR10, "10-bit Bayer BGBG/GRGR" } },
+	{ V4L2PixelFormat(V4L2_PIX_FMT_SBGGR10V32),
+		{ formats::SBGGR10, "10-bit Bayer BGBG/GRGR Vector" } },
 	{ V4L2PixelFormat(V4L2_PIX_FMT_SGBRG10),
 		{ formats::SGBRG10, "10-bit Bayer GBGB/RGRG" } },
 	{ V4L2PixelFormat(V4L2_PIX_FMT_SGRBG10),
-- 
2.51.0

